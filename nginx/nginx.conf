# nginx.conf
user  nginx;
worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    # 로그 포맷
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # 캐시 경로 선언
    # keys_zone=my_cache:10m  -> 메모리에 캐시 key를 저장할 공간(10MB)
    # inactive=10m           -> 10분 동안 사용이 없으면 캐시 제거
    # max_size=1g            -> 디스크 캐시 용량 한도 (예시로 1GB)
#     proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m inactive=10m max_size=1g;

    # 임시 파일 경로
    proxy_temp_path /var/cache/nginx/temp;

    # query_string이 없는 경우에만 캐시 활성화하기 위해 map 사용
    map $query_string $is_query_empty {
        ""       1;  # 쿼리 스트링이 비어있으면 1
        default  0;  # 그 외에는 0
    }

    #--------------------
        # 캐시 영역 설정
        #--------------------
        # (1) products 캐시
        proxy_cache_path /var/cache/nginx/products
                         levels=1:2
                         keys_zone=cache_products:10m
                         inactive=10m
                         max_size=1g;

        # (2) styles 캐시
        proxy_cache_path /var/cache/nginx/styles
                         levels=1:2
                         keys_zone=cache_styles:10m
                         inactive=10m
                         max_size=1g;

        #--------------------
        # map을 이용해 "쿼리 스트링이 비어있는가?" 체크
        #   ""  -> 0  (비어있으면 0)
        #   그외 -> 1  (뭔가 있으면 1)
        #--------------------
        map $query_string $bypass_products_cache {
            ""       0;  # 쿼리 파라미터가 없으면 0
            default  1;  # 그 외는 1
        }

        map $query_string $bypass_styles_cache {
            ""       0;
            default  1;
        }

    server {
        listen 80;
        server_name localhost;  # 실제 도메인 있으면 변경

        # 캐시에 대한 purge(무효화) 요청을 처리하기 위해서는
        # nginx에서 3rd-party 모듈(proxy_cache_purge 등)을 빌드해야 하는데,
        # 일단은 예시로만 위치 블록을 작성한다.
        #
        # location /purge/ {
        #   allow 127.0.0.1;  # 특정 IP에서만 purge 가능하도록 제한
        #   deny all;
        #   proxy_cache_purge my_cache $scheme$host$request_uri;
        # }

        location / {
            proxy_pass http://app:8080;  # Spring Boot 컨테이너로 라우팅
        }

        #--------------------------------------------
               # [상품 API 캐시] : /api/products/
               #
               #   - proxy_cache_bypass: 특정 변수가 1이면 캐시를 우회
               #   - proxy_no_cache:     1이면 캐시에 저장하지 않음
               #--------------------------------------------
               location /api/products/ {
                   proxy_pass http://app:8080;

                   proxy_cache            cache_products;   # 캐시 영역
                   proxy_cache_valid      200 10m;
                   proxy_cache_valid      404 1m;
                   add_header             X-Cache-Status $upstream_cache_status;

                   # 쿼리 스트링이 있으면(=1) 캐시 우회
                   proxy_cache_bypass     $bypass_products_cache;
                   proxy_no_cache         $bypass_products_cache;
               }

               #--------------------------------------------
               # [스타일 API 캐시] : /api/styles/queries
               #--------------------------------------------
               location /api/styles/queries {
                   proxy_pass http://app:8080;

                   proxy_cache            cache_styles;
                   proxy_cache_valid      200 10m;
                   proxy_cache_valid      404 1m;
                   add_header             X-Cache-Status $upstream_cache_status;

                   proxy_cache_bypass     $bypass_styles_cache;
                   proxy_no_cache         $bypass_styles_cache;
               }
               #--------------------------------------------
                       # [Purge 예시 - 별도 모듈 필요]
                       #   - 실제 purge를 위해서는 'proxy_cache_purge' 모듈이 필요
                       #   - 기본 nginx:latest 이미지에는 포함되지 않음
                       #--------------------------------------------
                       location ~ /purge(/.*) {
                           allow 127.0.0.1;  # 예: 로컬 IP만 허용
                           deny all;
                       #
                           # purge 요청 시 cache_products, cache_styles 둘 다 시도
                           # (URL에 따라 실제 purge가 가능한 cache만 작동)
                           proxy_cache_purge cache_products $scheme$host$1;
                           proxy_cache_purge cache_styles   $scheme$host$1;
                       }
    }
}
